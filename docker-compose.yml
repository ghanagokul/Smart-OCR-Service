version: "3.9"

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ocr
      POSTGRES_PASSWORD: ocr
      POSTGRES_DB: ocr
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  api:
    build: ./server
    command: ["/bin/bash", "/app/entrypoint.sh"]
    ports:
      - "8080:8080"
    env_file: .env
    environment:
      REDIS_URL: ${REDIS_URL}
      GCS_BUCKET: ${GCS_BUCKET}
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS}
      CORS_ORIGINS: ${CORS_ORIGINS}
      DB_URL: ${DB_URL} # ✅ Pass DB connection string
    volumes:
      - ./server:/app
      - ./secrets:/secrets:ro
    depends_on:
      - redis
      - db # ✅ Wait for Postgres

  worker:
    build: ./server
    command:
      [
        "celery",
        "-A",
        "tasks.celery_app",
        "worker",
        "--loglevel=INFO",
        "-Q",
        "ocr",
      ]
    env_file: .env
    environment:
      REDIS_URL: ${REDIS_URL}
      GCS_BUCKET: ${GCS_BUCKET}
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS}
      DB_URL: ${DB_URL} # ✅ Worker also needs DB access
    volumes:
      - ./server:/app
      - ./secrets:/secrets:ro
    depends_on:
      - redis
      - db

  web:
    build: ./client
    ports:
      - "5173:80"
    environment:
      VITE_API_BASE: http://localhost:8080
    depends_on:
      - api

volumes:
  pgdata:
